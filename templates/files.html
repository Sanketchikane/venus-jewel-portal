<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Venus Jewel | Files</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  :root {
    --vj-primary:#003366;
    --vj-accent:#0B5FFF;
    --vj-bg:#f4f7fb;
    --vj-card:#fff;
  }
  body {
    margin:0; font-family:'Poppins',sans-serif; background:var(--vj-bg);
    color:#203040;
  }
  header {
    background:#fff; display:flex; justify-content:space-between; align-items:center;
    padding:10px 18px; border-bottom:1px solid #e5e8ef; position:sticky; top:0; z-index:50;
  }
  header img { height:50px; }
  header .actions a { text-decoration:none; color:#203040; margin-left:12px; font-weight:500; }
  .container { max-width:1200px; margin:20px auto; padding:0 10px; }
  .controls { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px; }
  .controls input, .controls select { padding:8px 10px; border-radius:8px; border:1px solid #d3d8e2; }
  .controls button, .controls a {
    padding:8px 12px; border:none; border-radius:8px; cursor:pointer;
    background:var(--vj-accent); color:#fff; font-weight:500;
  }
  .browser { display:grid; grid-template-columns:300px 1fr; gap:16px; }
  .list { background:var(--vj-card); border-radius:10px; border:1px solid #e5e8ef; overflow:auto; max-height:70vh; }
  .list-item { padding:10px 12px; border-bottom:1px solid #f0f0f0; cursor:pointer; display:flex; align-items:center; justify-content:space-between; }
  .list-item:hover { background:#eef4ff; }
  .grid { width:100%; background:var(--vj-card); border-radius:10px; border-collapse:collapse; overflow:hidden; }
  .grid th, .grid td { padding:10px; border-bottom:1px solid #f0f0f0; text-align:left; }
  .grid th { background:#f8fafc; }
  @media(max-width:900px){
    .browser{ grid-template-columns:1fr; }
    .list{ max-height:40vh; }
  }
</style>
</head>
<body>
<header>
  <img src="{{ url_for('static', filename='images/venus_black_logo.jpg) }}" alt="Venus Jewel">
  <div class="actions">
    <span><i class="fas fa-user"></i> {{ user }}</span>
    <a href="/dashboard">Dashboard</a>
    <a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>
</header>

<div class="container">
  <div class="controls">
    <input id="searchBox" placeholder="Search folder or file...">
    <select id="sortSelect">
      <option value="newest">Newest First</option>
      <option value="name">Name Aâ€“Z</option>
    </select>
    <a id="downloadSingleBtn" href="#" disabled>Download Selected Folder</a>
    <button id="downloadMultiBtn" disabled>Download Selected (ZIP)</button>
  </div>

  <div class="browser">
    <div>
      <h3><i class="fas fa-folder"></i> Packet Folders</h3>
      <div id="packetList" class="list"></div>
    </div>
    <div>
      <h3 id="filesTitle"><i class="fas fa-file"></i> Files</h3>
      <table class="grid">
        <thead><tr><th>Name</th><th>Type</th><th>Modified</th><th>Actions</th></tr></thead>
        <tbody id="filesBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const packetList=document.getElementById('packetList');
const filesBody=document.getElementById('filesBody');
const searchBox=document.getElementById('searchBox');
const sortSelect=document.getElementById('sortSelect');
const downloadSingleBtn=document.getElementById('downloadSingleBtn');
const downloadMultiBtn=document.getElementById('downloadMultiBtn');
let folders=[],files=[],selected=new Set(),current=null;

function loadFolders(){
  packetList.innerHTML='<div class="list-item">Loading...</div>';
  fetch(`/api/packet-folders?sort=${sortSelect.value}`).then(r=>r.json()).then(d=>{
    folders=d.folders||[]; renderFolders();
  });
}
function renderFolders(){
  const q=searchBox.value.toLowerCase(); packetList.innerHTML='';
  folders.filter(f=>!q||(f.name||'').toLowerCase().includes(q)).forEach(f=>{
    const el=document.createElement('div');
    el.className='list-item';
    el.innerHTML=`<label style="flex:1;"><input type="checkbox" value="${f.id}"> ${f.name}</label><small>${new Date(f.modifiedTime).toLocaleDateString()}</small>`;
    const cb=el.querySelector('input');
    cb.onchange=()=>{cb.checked?selected.add(f.id):selected.delete(f.id);updateBtns();};
    el.onclick=(e)=>{if(e.target.tagName!=='INPUT')selectFolder(f.id,f.name);};
    packetList.appendChild(el);
  });
}
function selectFolder(id,name){
  current={id,name}; downloadSingleBtn.href=`/download/folder/${id}`; downloadSingleBtn.removeAttribute('disabled');
  fetch(`/api/folder/${id}/files?sort=${sortSelect.value}`).then(r=>r.json()).then(d=>{
    files=d.files||[]; renderFiles();
  });
}
function renderFiles(){
  filesBody.innerHTML='';
  files.forEach(f=>{
    const tr=document.createElement('tr');
    const date=f.modifiedTime?new Date(f.modifiedTime).toLocaleString():'';
    tr.innerHTML=`<td>${f.name}</td><td>${f.mimeType||''}</td><td>${date}</td>
    <td>
      <button onclick="openPreview('${f.id}','${f.mimeType||''}')"><i class="fas fa-eye"></i></button>
      <a href="/download/file/${f.id}"><i class="fas fa-download"></i></a>
      <button onclick="shareFile('${f.id}')"><i class="fas fa-share-alt"></i></button>
    </td>`;
    filesBody.appendChild(tr);
  });
}
function updateBtns(){
  downloadMultiBtn.disabled=selected.size===0;
  downloadSingleBtn.disabled=selected.size===0;
}
downloadMultiBtn.onclick=()=>{
  const form=document.createElement('form');form.method='POST';form.action='/download/folders';
  selected.forEach(id=>{const i=document.createElement('input');i.type='hidden';i.name='folder_ids[]';i.value=id;form.appendChild(i);});
  document.body.appendChild(form);form.submit();form.remove();
};
function openPreview(id,mime){
  window.open(`/preview/file/${id}`,'_blank');
}
async function shareFile(id){
  const linkRes=await fetch(`/api/share-link?id=${id}`);const link=(await linkRes.json()).link;
  const file=await fetch(`/download/file/${id}`);const blob=await file.blob();
  const name=file.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/["']/g,'')||'file';
  const f=new File([blob],name,{type:blob.type});
  if(navigator.canShare&&navigator.canShare({files:[f]})){await navigator.share({files:[f],title:name,text:'Venus File'});}
  else{await navigator.clipboard.writeText(link);alert('Share link copied & file downloaded.');const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;document.body.appendChild(a);a.click();a.remove();}
}
searchBox.oninput=renderFolders;sortSelect.onchange=loadFolders;loadFolders();
</script>
</body>
</html>
