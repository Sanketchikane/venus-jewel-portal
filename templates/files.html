<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Files • VENUS JEWEL FILE PORTAL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: Poppins, sans-serif;
            margin: 0;
            background: #f4f7ff;
        }

        /* Highlight selected folders */
        .selected-folder {
            background: rgba(11, 95, 255, 0.18) !important;
            border-left: 4px solid #0B5FFF;
        }

        /* Loader spinner */
        #loader {
            display: none;
            margin: 10px auto;
            width: 40px;
            height: 40px;
            border: 5px solid #d0d7e3;
            border-top-color: #0B5FFF;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Preview Modal */
        #previewModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        #previewClose {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            width: 32px;
            height: 32px;
            border-radius: 100%;
            cursor: pointer;
            z-index: 10000;
        }
    </style>
</head>
<body>

<!-- TOPBAR -->
<div style="padding:12px;background:white;border-bottom:1px solid #cfd5e1;display:flex;justify-content:space-between;align-items:center;">
    <img src="{{ url_for('static', filename='images/venus_black_logo.jpg') }}" height="45">
    <div>
        <span><i class="fa fa-user-circle"></i> {{ user }}</span>
        <a href="/dashboard" class="btn">Dashboard</a>
        <a href="/logout" class="btn">Logout</a>
    </div>
</div>

<div style="max-width:1250px;margin:20px auto;background:white;padding:20px;border-radius:12px;">
    <div style="display:flex;gap:10px;">
        <input id="searchBox" style="flex:1;padding:10px" placeholder="Search folder...">
        <select id="sortSelect" style="padding:10px;">
            <option value="newest">Newest</option>
            <option value="name">A–Z</option>
        </select>
        <button id="refreshBtn" class="btn">Refresh</button>
        <button id="downloadFolderBtn" class="btn btn-primary" disabled>Download Selected</button>
    </div>

    <div id="loader"></div>

    <div style="display:grid;grid-template-columns:280px 1fr;gap:15px;margin-top:20px;">

        <!-- LEFT PANEL -->
        <div style="border:1px solid #cfd5e1;padding:12px;border-radius:12px;">
            <h3><i class="fa fa-folder"></i> Packet Folders</h3>

            <label style="display:flex;gap:8px;margin:10px 0;">
                <input type="checkbox" id="selectAll" disabled>
                <strong>Select All</strong>
            </label>

            <div id="packetList" style="max-height:60vh;overflow:auto;border:1px solid #cfd5e1;border-radius:10px;"></div>
        </div>

        <!-- RIGHT PANEL -->
        <div style="border:1px solid #cfd5e1;padding:12px;border-radius:12px;">
            <h3 id="filesTitle"><i class="fa fa-file"></i> Files</h3>
            <table style="width:100%;border-collapse:collapse;">
                <thead><tr><th>Name</th><th>Type</th><th>Modified</th><th>Actions</th></tr></thead>
                <tbody id="filesBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- PREVIEW MODAL -->
<div id="previewModal">
    <button id="previewClose" onclick="closePreview()">✕</button>
    <video id="previewVideo" controls></video>
    <img id="previewImage">
    <iframe id="previewFrame"></iframe>
</div>

<script>
let allFolders = [];
let selectedFolders = [];
let currentFolder = null;

/* ---------- LOADER ---------- */
function showLoader(){ loader.style.display="block"; }
function hideLoader(){ loader.style.display="none"; }

/* ---------- LOAD FOLDERS ---------- */
function loadFolders(){
    showLoader();
    fetch(`/file/api/packet-folders?sort=${sortSelect.value}`)
        .then(r=>r.json())
        .then(d=>{
            allFolders = d.folders || [];
            selectAll.disabled = false;
            renderFolders();
            hideLoader();
        });
}

/* ---------- RENDER FOLDERS ---------- */
function renderFolders(){
    packetList.innerHTML = "";
    let q = searchBox.value.toLowerCase();

    allFolders
        .filter(f => f.name.toLowerCase().includes(q))
        .forEach(folder => {
            let row = document.createElement("div");
            row.style.padding="10px";
            row.style.display="flex";
            row.style.gap="8px";
            row.style.cursor="pointer";
            row.style.borderBottom="1px solid #eee";

            if (selectedFolders.includes(folder.id)){
                row.classList.add("selected-folder");
            }

            row.innerHTML = `
                <input type="checkbox" class="folderChk" data-id="${folder.id}"
                    ${selectedFolders.includes(folder.id)?"checked":""}>
                <span><i class="fa fa-folder"></i> ${folder.name}</span>
            `;

            packetList.appendChild(row);
        });

    updateButtons();
}

/* ---------- SELECT ALL ---------- */
selectAll.addEventListener("change",()=>{
    selectedFolders = selectAll.checked ? allFolders.map(f=>f.id) : [];
    renderFolders();
});

/* ---------- INDIVIDUAL CHECKBOX ---------- */
packetList.addEventListener("change",e=>{
    if (!e.target.classList.contains("folderChk")) return;
    let id = e.target.dataset.id;

    if (e.target.checked){
        selectedFolders.push(id);
    } else {
        selectedFolders = selectedFolders.filter(x=>x!==id);
        selectAll.checked = false;
    }

    renderFolders();
});

/* ---------- UPDATE BUTTON ---------- */
function updateButtons(){
    downloadFolderBtn.disabled = selectedFolders.length === 0;
}

/* ---------- DOWNLOAD MULTI FOLDERS ---------- */
downloadFolderBtn.onclick = ()=>{
    let ids = selectedFolders.join(",");
    window.location.href = `/file/download/folders-zip/${ids}`;
};

/* ---------- INITIAL LOAD ---------- */
loadFolders();
</script>

</body>
</html>
