{% extends "admin_dashboard.html" %}

{% block content %}

<style>
  .card {
    background: white;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 4px 18px rgba(0,0,0,0.12);
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th {
    background: #004080;
    color: white;
    padding: 10px;
  }
  td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
  }
  tr:hover {
    background: #eef4ff;
  }
</style>

<div class="card">

  <h2 class="text-2xl font-bold text-blue-800 mb-4">Registered Users</h2>

  <table>
    <thead>
      <tr>
        <th>Full Name</th>
        <th>Username</th>
        <th>Email</th>
        <th>Organization</th>
        <th>Contact</th>
        <th>View</th>
      </tr>
    </thead>
    <tbody>
    {% for user in users %}
      <tr>
        <td>{{ user['Full Name'] }}</td>
        <td>{{ user['Username'] }}</td>
        <td>{{ user['Email'] }}</td>
        <td>{{ user['Organization'] }}</td>
        <td>{{ user['Contact Number'] }}</td>
        <td>
          <button onclick="openUser('{{ user['Username']|e }}')" class="bg-blue-600 text-white px-3 py-1 rounded">View</button>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>


  <!-- Pending Registration -->
  <h2 id="pending" class="text-2xl mt-10 font-bold text-blue-800">Pending Registrations</h2>

  <table id="pending-table">
    <thead>
      <tr>
        <th>Full Name</th>
        <th>Email</th>
        <th>Contact</th>
        <th>Organization</th>
        <th>Status</th>
        <th>Approve</th>
      </tr>
    </thead>
    <tbody id="pending-body">
      <tr><td colspan="6" class="text-center">Loading...</td></tr>
    </tbody>
  </table>


  <!-- Forgot Password Requests -->
  <h2 id="forgot-password" class="text-2xl mt-10 font-bold text-blue-800">Forgot Password Requests</h2>

  <table id="forgot-table">
    <thead>
      <tr>
        <th>Full Name</th>
        <th>Username</th>
        <th>Email</th>
        <th>Organization</th>
        <th>Contact</th>
        <th>Request Date</th>
        <th>Reset</th>
      </tr>
    </thead>
    <tbody id="forgot-body">
      <tr><td colspan="7" class="text-center">Loading...</td></tr>
    </tbody>
  </table>

</div>

<script>

function openUser(username) {
  window.location.href = "/admin/view-user/" + encodeURIComponent(username);
}

// Load Pending Registrations
async function loadPending() {
  const res = await fetch("/admin/api/pending-registrations");
  const data = await res.json();
  const tbody = document.getElementById("pending-body");

  tbody.innerHTML = "";

  if (!data.pending || data.pending.length === 0) {
    tbody.innerHTML = "<tr><td colspan='6' class='text-center'>No pending requests</td></tr>";
    return;
  }

  data.pending.forEach(r => {
    tbody.innerHTML += `
      <tr>
        <td>${r["Full Name"]}</td>
        <td>${r["Email"]}</td>
        <td>${r["Contact"]}</td>
        <td>${r["Organization"]}</td>
        <td>${r["Status"]}</td>
        <td>
          <form method="POST" action="/admin/create-credential">
            <input type="hidden" name="email" value="${r["Email"]}">
            <input type="text" name="username" placeholder="Username" required>
            <input type="text" name="password" placeholder="Password" required>
            <button class="bg-green-600 text-white px-3 py-1 rounded">Approve</button>
          </form>
        </td>
      </tr>`;
  });
}

// Load Forgot Password Requests
async function loadForgot() {
  const res = await fetch("/admin/api/pending-forgot-passwords");
  const data = await res.json();

  const tbody = document.getElementById("forgot-body");
  tbody.innerHTML = "";

  if (!data.pending || data.pending.length === 0) {
    tbody.innerHTML = "<tr><td colspan='7' class='text-center'>No requests</td></tr>";
    return;
  }

  data.pending.forEach((r, index) => {
    tbody.innerHTML += `
      <tr>
        <td>${r["Full Name"]}</td>
        <td>${r["Username"]}</td>
        <td>${r["Email"]}</td>
        <td>${r["Organization"]}</td>
        <td>${r["Contact Number"]}</td>
        <td>${r["Request Date"]}</td>
        <td>
          <form method="POST" action="/admin/reset-forgot-password">
            <input type="hidden" name="username" value="${r["Username"]}">
            <input type="password" name="new_password" placeholder="New Password" required>
            <input type="hidden" name="request_row" value="${index + 2}">
            <button class="bg-blue-600 text-white px-3 py-1 rounded">Reset</button>
          </form>
        </td>
      </tr>`;
  });
}

loadPending();
loadForgot();
</script>

{% endblock %}
