{% extends "admin_dashboard.html" %}
{% block content %}

<!-- Splash Screen -->
<div id="splash" class="fixed inset-0 flex items-center justify-center bg-white/70 backdrop-blur-lg z-[9999] transition-opacity duration-700">
  <img src="{{ url_for('static', filename='images/wings_new.gif') }}" alt="Loading..." class="w-1/2 md:w-1/3 animate-pulse">
</div>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      const splash = document.getElementById('splash');
      splash.classList.add('opacity-0');
      setTimeout(() => splash.remove(), 700);
    }, 2000);
  });
</script>

<style>
  .user-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 16px;
    padding: 30px 20px;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.12);
    max-width: 1150px;
    margin: 40px auto;
    font-family: 'Poppins', sans-serif;
    backdrop-filter: blur(10px);
  }
  .pending-title {
    font-size: 22px;
    color: #0066cc;
    margin: 20px 0 10px;
  }
  .user-table { width: 100%; border-collapse: collapse; font-size: 15px; }
  .user-table thead {
    background: linear-gradient(to right, #004080, #0073e6);
    color: white;
  }
  .user-table th, .user-table td {
    padding: 12px 14px;
    border-bottom: 1px solid #ddd;
    text-align: left;
  }
  .user-table tbody tr:hover { background-color: #f0f7ff; cursor: pointer; }
  @media (max-width: 768px) {
    .user-card { padding: 15px; margin: 20px auto; }
    .user-table th, .user-table td { font-size: 13px; padding: 8px; }
  }
</style>

<div class="user-card">
  <h2 class="text-center text-2xl font-bold text-venusBlue mb-4">ðŸ‘¥ Registered Users â€“ Venus File Portal</h2>

  {% if users and users|length > 0 %}
  <div class="overflow-x-auto">
    <table class="user-table">
      <thead><tr><th>Full Name</th><th>Username</th><th>Email</th><th>Organization</th><th>Contact</th><th>Action</th></tr></thead>
      <tbody>
        {% for user in users %}
        <tr onclick="openUser('{{ user['Username'] }}')">
          <td>{{ user['Full Name'] }}</td>
          <td>{{ user['Username'] }}</td>
          <td>{{ user['Email'] }}</td>
          <td>{{ user['Organization'] }}</td>
          <td>{{ user['Contact'] }}</td>
          <td><button class="bg-blue-600 text-white px-3 py-1 rounded">View</button></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="text-center text-gray-500">No approved users found.</p>
  {% endif %}

  <h3 class="pending-title">ðŸ•’ Pending Registration Requests</h3>
  <div class="overflow-x-auto">
    <table class="user-table" id="pending-table">
      <thead><tr><th>Full Name</th><th>Email</th><th>Contact</th><th>Organization</th><th>Status</th><th>Approve</th></tr></thead>
      <tbody id="pending-body"><tr><td colspan="6" class="text-center">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<script>
async function loadPending() {
  const res = await fetch("/api/pending-registrations");
  const data = await res.json();
  const tbody = document.getElementById("pending-body");
  tbody.innerHTML = "";
  if (!data.pending || data.pending.length === 0) {
    tbody.innerHTML = "<tr><td colspan='6' class='text-center'>No pending requests.</td></tr>";
    return;
  }
  data.pending.forEach(r => {
    const email = r["Email"] || "";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r["Full Name"] || ""}</td>
      <td>${email}</td>
      <td>${r["Contact"] || ""}</td>
      <td>${r["Organization"] || ""}</td>
      <td>${r["Status"] || "Pending"}</td>
      <td>
        <form class="inline-form" method="POST" action="/admin/create-credential">
          <input type="hidden" name="email" value="${email}">
          <input type="text" name="username" placeholder="Username" required>
          <input type="text" name="password" placeholder="Password" required>
          <button type="submit">Approve</button>
        </form>
      </td>`;
    tbody.appendChild(tr);
  });
}

function openUser(username) {
  window.open(`/admin/view-user/${username}`, "_blank");
}

loadPending();
</script>

{% endblock %}
